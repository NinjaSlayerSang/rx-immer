import { map, Observable } from 'rxjs';
import type { Immutable } from 'immer';
import { JSONPath } from 'jsonpath-plus';

import type { Objectish } from '../type';
import type { Base } from '../core/base';

export interface QueryPluginExt {
  find<V = any>(path: string): Immutable<V[]>;

  query<V = any>(path: string): Observable<Immutable<V[]>>;
}

export default {
  name: 'query-plugin',
  generate(Cls: typeof Base): any {
    return class<T extends Objectish> extends Cls<T> implements QueryPluginExt {
      public find(path: string) {
        return JSONPath({ path, json: this.value() });
      }

      public query(path: string) {
        return this.observe().pipe(map((json) => JSONPath({ path, json })));
      }
    };
  },
};
